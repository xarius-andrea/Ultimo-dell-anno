<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Festa 31 Dicembre</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f4f4f4;color:#222}
header{background:#111;color:#fff;padding:1rem;text-align:center}
section{padding:1rem}
.card{background:#fff;border-radius:14px;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 10px rgba(0,0,0,.08)}
h2{margin-top:0;font-size:1.2rem}
button{background:#111;color:#fff;border:none;border-radius:10px;padding:.4rem .7rem;font-size:.85rem}
button.remove{background:#b00020}
button.add{margin-top:.5rem}
table{width:100%;border-collapse:collapse}
th,td{padding:.4rem;font-size:.85rem}
th{background:#eee;text-align:left}
tr:nth-child(even) td{background:#fafafa}
input[type=text],input[type=number]{width:100%;border:none;background:transparent;font-size:.85rem}
input:focus{outline:none;background:#e8f0fe;border-radius:6px}
.summary{display:grid;gap:1rem}
.summary-group{border-radius:16px;padding:1rem;background:#fafafa;box-shadow:inset 0 0 0 1px #e5e5e5}
.summary-group h3{margin:.2rem 0 .6rem 0;font-size:.95rem;color:#444}
.summary-group div{margin:.35rem 0;font-weight:500}
.summary strong{font-weight:700}
.small{font-size:.8rem;color:#555}
</style>
</head>
<body>
<header><h1>Festa 31 Dicembre</h1></header>

<section class="card">
<h2>Partecipanti</h2>
<table id="people">
<thead><tr><th>Nome</th><th>Pagato</th><th>Alcol</th><th></th></tr></thead>
<tbody></tbody>
</table>
<button class="add" onclick="addPerson()">âž• Aggiungi partecipante</button>
</section>

<section class="card">
<h2>Spese cibo / materiali</h2>
<table id="items">
<thead><tr><th>Voce</th><th>â‚¬</th><th></th></tr></thead>
<tbody></tbody>
</table>
<button class="add" onclick="addItem('items')">âž• Aggiungi voce</button>
</section>

<section class="card">
<h2>Spese alcolici</h2>
<table id="alcohol">
<thead><tr><th>Alcolico</th><th>â‚¬</th><th></th></tr></thead>
<tbody></tbody>
</table>
<button class="add" onclick="addItem('alcohol')">âž• Aggiungi alcolico</button>
</section>

<section class="card">
<h2>Quote</h2>
<div class="summary">

<div class="summary-group">
<h3>Quota base</h3>
<div>Quota stimata: â‚¬ <input type="number" id="estimated" value="10" step="0.1"></div>
</div>

<div class="summary-group">
<h3>Alcolici</h3>
<div>Totale alcolici: â‚¬ <span id="alcoholTotal">0.00</span></div>
<div>Costo alcolici a persona: â‚¬ <span id="alcoholPer">0.00</span></div>
<div>Quota senza alcolici: â‚¬ <span id="noAlcohol">0.00</span></div>
</div>

<div class="summary-group">
<h3>Riepilogo quote</h3>
<div>Totale quote ricevute: â‚¬ <span id="received">0.00</span></div>
<div>Quote totali stimate: â‚¬ <span id="totalEstimated">0.00</span></div>
<div>Budget rimanente: â‚¬ <span id="remaining">0.00</span></div>
<div>Budget rimanente stimato: â‚¬ <span id="remainingEstimated">0.00</span></div>
</div>

</div>
</section>

<script type="module">
// ðŸ”¥ Firebase setup
import { initializeApp } from "firebase/app";
import { getDatabase, ref, onValue, push, update } from "firebase/database";

const firebaseConfig = {
  apiKey: "AIzaSyByVZHzFIUcsGibzWkCuxn1nKevrvTTOc0",
  authDomain: "capodanno-c2669.firebaseapp.com",
  databaseURL: "https://capodanno-c2669-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "capodanno-c2669",
  storageBucket: "capodanno-c2669.appspot.com",
  messagingSenderId: "656788642680",
  appId: "1:656788642680:web:3db3d5f76679f34595468d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const stateRef = ref(db, 'capodanno/state');

let state = {
  estimated: 10,
  people: [],
  items: [],
  alcohol: []
};

// ===== RENDER =====
function render() {
  document.getElementById('estimated').value = state.estimated;

  const pBody = document.querySelector('#people tbody');
  pBody.innerHTML = '';
  state.people.forEach((p, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="name" value="${p.name}"></td>
      <td><input type="checkbox" class="paid" ${p.paid?'checked':''}></td>
      <td><input type="checkbox" class="drink" ${p.drink?'checked':''}></td>
      <td><button class="remove">âœ–</button></td>
    `;
    tr.querySelector('.name').oninput = e => { state.people[i].name = e.target.value; savePerson(i); };
    tr.querySelector('.paid').onchange = e => { state.people[i].paid = e.target.checked; savePerson(i); };
    tr.querySelector('.drink').onchange = e => { state.people[i].drink = e.target.checked; savePerson(i); };
    tr.querySelector('button').onclick = () => { removePerson(i); };
    pBody.appendChild(tr);
  });

  renderTable('items');
  renderTable('alcohol');
  calc();
}

function renderTable(id) {
  const body = document.querySelector(`#${id} tbody`);
  body.innerHTML = '';
  state[id].forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="name" value="${r.name}"></td>
      <td><input type="number" step="0.01" value="${r.price}"></td>
      <td><button class="remove">âœ–</button></td>
    `;
    tr.querySelector('.name').oninput = e => { state[id][i].name = e.target.value; saveItem(id, i); };
    tr.querySelector('input[type=number]').oninput = e => { state[id][i].price = parseFloat(e.target.value)||0; saveItem(id, i); };
    tr.querySelector('button').onclick = () => { removeItem(id, i); };
    body.appendChild(tr);
  });
}

// ===== CALCOLI =====
function sum(arr){ return arr.reduce((a,b)=>a+(b.price||0),0); }

function calc(){
  const food = sum(state.items);
  const alcohol = sum(state.alcohol);
  const drinkers = state.people.filter(p=>p.drink).length;
  const nonDrinkers = state.people.filter(p=>!p.drink).length;
  const alcoholPer = drinkers ? alcohol/drinkers : 0;
  const quotaNo = Math.max(state.estimated - alcoholPer, 0);
  const received = state.people.filter(p=>p.paid).length * state.estimated;
  const totalEstimated = (drinkers*state.estimated) + (nonDrinkers*quotaNo);
  const spent = food + alcohol;

  document.getElementById('alcoholTotal').textContent = alcohol.toFixed(2);
  document.getElementById('alcoholPer').textContent = alcoholPer.toFixed(2);
  document.getElementById('noAlcohol').textContent = quotaNo.toFixed(2);
  document.getElementById('received').textContent = received.toFixed(2);
  document.getElementById('totalEstimated').textContent = totalEstimated.toFixed(2);
  document.getElementById('remaining').textContent = (received - spent).toFixed(2);
  document.getElementById('remainingEstimated').textContent = (totalEstimated - spent).toFixed(2);
}

// ===== AZIONI =====
window.addPerson = () => {
  const newPerson = {name:'', paid:false, drink:true};
  const pRef = push(ref(db, 'capodanno/people'));
  newPerson.key = pRef.key;
  pRef.set(newPerson);
};

function savePerson(i){
  const p = state.people[i];
  const pRef = ref(db, `capodanno/people/${p.key}`);
  update(pRef, {name:p.name, paid:p.paid, drink:p.drink});
}

function removePerson(i){
  const p = state.people[i];
  const pRef = ref(db, `capodanno/people/${p.key}`);
  pRef.remove();
}

window.addItem = id => {
  const newItem = {name:'', price:0};
  const itemRef = push(ref(db, `capodanno/${id}`));
  newItem.key = itemRef.key;
  itemRef.set(newItem);
};

function saveItem(id, i){
  const item = state[id][i];
  const itemRef = ref(db, `capodanno/${id}/${item.key}`);
  update(itemRef, {name:item.name, price:item.price});
}

function removeItem(id, i){
  const item = state[id][i];
  const itemRef = ref(db, `capodanno/${id}/${item.key}`);
  itemRef.remove();
}

document.getElementById('estimated').oninput = e => {
  state.estimated = parseFloat(e.target.value)||0;
  update(ref(db, 'capodanno'), {estimated: state.estimated});
}

// ===== FIREBASE SYNC =====
onValue(ref(db, 'capodanno'), snap => {
  if (snap.exists()){
    const dbState = snap.val();

    // Convert people/items/alcohol to array with keys
    state.people = Object.entries(dbState.people||{}).map(([k,v])=>({...v, key:k}));
    state.items = Object.entries(dbState.items||{}).map(([k,v])=>({...v, key:k}));
    state.alcohol = Object.entries(dbState.alcohol||{}).map(([k,v])=>({...v, key:k}));
    state.estimated = dbState.estimated || 10;

    render();
  }
});

// init
update(ref(db, 'capodanno'), state);
</script>
</body>
</html>
